function Sketchpad(a){for(var b in this.constructor.prototype)this[b]=this[b].bind(this);a.hasOwnProperty("element")?(this.element="string"===typeof a.element?$(a.element):a.element,this._width=a.width||this.element.attr("data-width")||0,this._height=a.height||this.element.attr("data-height")||0,this.color=a.color||this.element.attr("data-color")||"#000000",this.penSize=a.penSize||this.element.attr("data-penSize")||5,(this.readOnly=a.readOnly||this.element.attr("data-readOnly")||!1)||this.element.css({cursor:"crosshair"}),
this.strokes=a.strokes||[],this._currentStroke={color:null,size:null,lines:[]},this.undoHistory=a.undoHistory||[],this.animateIds=[],this._sketching=!1,this.reset()):console.error("SKETCHPAD ERROR: No element selected")}Sketchpad.prototype._cursorPosition=function(a){return{x:a.pageX-$(this.canvas).offset().left,y:a.pageY-$(this.canvas).offset().top}};Sketchpad.prototype._draw=function(a,b,c,d){this._stroke(a,b,c,d,"source-over")};
Sketchpad.prototype._erase=function(a,b,c,d){this._stroke(a,b,c,d,"destination-out")};Sketchpad.prototype._stroke=function(a,b,c,d,e){this.context.save();this.context.lineJoin="round";this.context.lineCap="round";this.context.strokeStyle=c;this.context.lineWidth=d;this.context.globalCompositeOperation=e;this.context.beginPath();this.context.moveTo(a.x,a.y);this.context.lineTo(b.x,b.y);this.context.closePath();this.context.stroke();this.context.restore()};
Sketchpad.prototype._mouseDown=function(a){this._lastPosition=this._cursorPosition(a);this._currentStroke.color=this.color;this._currentStroke.size=this.penSize;this._currentStroke.lines=[];this._sketching=!0;this.canvas.addEventListener("mousemove",this._mouseMove)};Sketchpad.prototype._mouseUp=function(a){this._sketching&&(0<this._currentStroke.lines.length&&this.strokes.push($.extend(!0,{},this._currentStroke)),this._sketching=!1);this.canvas.removeEventListener("mousemove",this._mouseMove)};
Sketchpad.prototype._mouseMove=function(a){a=this._cursorPosition(a);this._draw(this._lastPosition,a,this.color,this.penSize);this._currentStroke.lines.push({start:$.extend(!0,{},this._lastPosition),end:$.extend(!0,{},a)});this._lastPosition=a};
Sketchpad.prototype._touchStart=function(a){a.preventDefault();this._sketching||(this._lastPosition=this._cursorPosition(a.changedTouches[0]),this._currentStroke.color=this.color,this._currentStroke.size=this.penSize,this._currentStroke.lines=[],this._sketching=!0,this.canvas.addEventListener("touchmove",this._touchMove,!1))};
Sketchpad.prototype._touchEnd=function(a){a.preventDefault();this._sketching&&(this.strokes.push($.extend(!0,{},this._currentStroke)),this._sketching=!1);this.canvas.removeEventListener("touchmove",this._touchMove)};Sketchpad.prototype._touchCancel=function(a){a.preventDefault();this._sketching&&(this.strokes.push($.extend(!0,{},this._currentStroke)),this._sketching=!1);this.canvas.removeEventListener("touchmove",this._touchMove)};
Sketchpad.prototype._touchLeave=function(a){a.preventDefault();this._sketching&&(this.strokes.push($.extend(!0,{},this._currentStroke)),this._sketching=!1);this.canvas.removeEventListener("touchmove",this._touchMove)};Sketchpad.prototype._touchMove=function(a){a.preventDefault();a=this._cursorPosition(a.changedTouches[0]);this._draw(this._lastPosition,a,this.color,this.penSize);this._currentStroke.lines.push({start:$.extend(!0,{},this._lastPosition),end:$.extend(!0,{},a)});this._lastPosition=a};
Sketchpad.prototype.reset=function(){this.canvas=this.element[0];this.canvas.width=this._width;this.canvas.height=this._height;this.context=this.canvas.getContext("2d");this.redraw(this.strokes);this.readOnly||(this.canvas.addEventListener("mousedown",this._mouseDown),this.canvas.addEventListener("mouseout",this._mouseUp),this.canvas.addEventListener("mouseup",this._mouseUp),this.canvas.addEventListener("touchstart",this._touchStart),this.canvas.addEventListener("touchend",this._touchEnd),this.canvas.addEventListener("touchcancel",
this._touchCancel),this.canvas.addEventListener("touchleave",this._touchLeave))};Sketchpad.prototype.drawStroke=function(a){for(var b=0;b<a.lines.length;b++){var c=a.lines[b];this._draw(c.start,c.end,a.color,a.size)}};Sketchpad.prototype.redraw=function(a){for(var b=0;b<a.length;b++)this.drawStroke(a[b])};Sketchpad.prototype.toObject=function(){return{width:this.canvas.width,height:this.canvas.height,strokes:this.strokes,undoHistory:this.undoHistory}};Sketchpad.prototype.toJSON=function(){return JSON.stringify(this.toObject())};
Sketchpad.prototype.animate=function(a,b,c){this.clear();for(var d=a,e,g=0;g<this.strokes.length;g++)for(var f=this.strokes[g],h=0;h<f.lines.length;h++)e=f.lines[h],e=this._draw.bind(this,e.start,e.end,f.color,f.size),this.animateIds.push(setTimeout(e,d)),d+=a;b&&(c=c||0,e=this.animate.bind(this,a,b,c),this.animateIds.push(setTimeout(e,d+c)))};Sketchpad.prototype.cancelAnimation=function(){for(var a=0;a<this.animateIds.length;a++)clearTimeout(this.animateIds[a])};
Sketchpad.prototype.clear=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)};Sketchpad.prototype.undo=function(){this.clear();var a=this.strokes.pop();a&&(this.undoHistory.push(a),this.redraw(this.strokes))};Sketchpad.prototype.redo=function(){var a=this.undoHistory.pop();a&&(this.strokes.push(a),this.drawStroke(a))};
